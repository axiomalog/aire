<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proceso de Pago - FacturePay</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- RESET & BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #ffffff;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER --- */
        .site-header {
            position: relative;
            height: 90px;
            background-color: #ffffff;
            display: flex;
            align-items: center;
            padding: 0 5%;
            overflow: hidden; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .site-header::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            width: 65%; 
            background: linear-gradient(90deg, #004e7c 0%, #003a5d 100%);
            transform: skewX(-30deg);
            transform-origin: bottom right;
            z-index: 1;
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
        }

        .header-logos {
            position: relative;
            z-index: 10;
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 1200px;
        }

        .logo-aire { height: 55px; width: auto; }
        .header-divider { height: 45px; width: 2px; background-color: #003a5d; margin: 0 25px; }
        .logo-facture { height: 38px; width: auto; }

        @media (max-width: 768px) {
            .site-header { height: 70px; padding: 0 15px; }
            .site-header::after { width: 25%; transform: skewX(-15deg); box-shadow: none; }
            .logo-aire { height: 32px; }
            .header-divider { height: 25px; margin: 0 12px; }
            .logo-facture { height: 24px; }
            .header-logos { justify-content: flex-start; }
        }

        /* --- MAIN CONTENT --- */
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex-grow: 1;
        }

        .page-title {
            color: #00609c;
            font-size: 22px;
            font-weight: 400;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 2px solid #00abc8;
            width: 100%;
        }

        .content-wrapper {
            display: flex;
            gap: 30px;
            margin-top: 30px;
        }

        /* --- IZQUIERDA --- */
        .left-panel { flex: 1; max-width: 500px; }
        .info-table-container { border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .table-header { background-color: #003a5d; color: white; padding: 8px 15px; font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .data-table td { padding: 8px 15px; border-bottom: 1px solid #eee; }
        .data-table tr:last-child td { border-bottom: none; }
        .label-col { text-align: right; color: #666; width: 35%; font-weight: 500; }
        .value-col { text-align: left; color: #333; font-weight: 400; width: 65%; }

        .email-box { background-color: #f5f5f5; padding: 5px 10px; border-radius: 4px; display: inline-block; width: 100%; }
        .link-change { display: block; font-size: 11px; color: #666; text-decoration: underline; margin-top: 2px; cursor: pointer; transition: color 0.2s; }
        .link-change:hover { color: #005eb8; }

        .concepts-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .concepts-table th { background-color: #003a5d; color: white; padding: 8px; text-align: left; font-weight: 700; }
        .concepts-table th:last-child { text-align: right; }
        .concepts-table td { padding: 10px 8px; border-bottom: 1px solid #eee; color: #333; }
        .concepts-table td:last-child { text-align: right; }
        .row-total { background-color: #e6f4ea; font-weight: 700; }
        .row-total td { border-top: 1px solid #c8e6c9; color: #000; }

        /* --- DERECHA --- */
        .right-panel { flex: 1.2; background: white; padding: 0 10px; }
        .section-title { color: #005eb8; font-size: 18px; margin-bottom: 25px; font-weight: 400; }
        .payment-method-select { display: flex; align-items: center; margin-bottom: 30px; }
        .radio-custom { margin-right: 15px; transform: scale(1.5); accent-color: #005eb8; cursor: pointer; }
        .pse-logo { width: 90px; height: auto; margin-right: 10px; }
        .pse-text { font-weight: 700; font-size: 14px; color: #333; }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 11px; color: #666; margin-bottom: 5px; font-weight: 500; }
        .form-control-line { width: 100%; border: none; border-bottom: 1px solid #dcdcdc; padding: 8px 0; font-size: 14px; color: #333; background: transparent; transition: border-color 0.3s; }
        .form-control-line::placeholder { color: #aaa; }
        .form-control-line:focus { border-bottom: 1px solid #005eb8; }

        .actions-container { display: flex; gap: 20px; margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px; justify-content: space-between; }
        .btn-action { flex: 1; padding: 10px; border-radius: 4px; font-size: 14px; font-weight: 500; cursor: pointer; text-align: center; max-width: 48%; }
        .btn-pay { background-color: #003a5d; color: white; border: none; }
        .btn-pay:hover { background-color: #002840; }
        .btn-cancel { background-color: white; color: #00abc8; border: 1px solid #00abc8; }
        .btn-cancel:hover { background-color: #f9f9f9; }

        /* --- FOOTER --- */
        .footer-strip { margin-top: auto; padding: 20px 0; text-align: center; }
        .footer-note { font-size: 10px; color: #333; text-align: left; max-width: 1200px; margin: 0 auto 20px auto; padding: 0 20px; line-height: 1.4; }
        .footer-note a { color: #005eb8; text-decoration: none; }
        .security-badges { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .bottom-bar { background-color: #003a5d; color: white; font-size: 11px; padding: 10px; text-align: center; font-weight: 700; }

        @media (max-width: 768px) {
            .content-wrapper { flex-direction: column; }
            .left-panel, .right-panel { max-width: 100%; }
        }

        /* --- ESTILOS MODAL DE CORREO --- */
        .custom-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 58, 93, 0.6);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .custom-modal-box {
            background-color: white;
            width: 90%;
            max-width: 400px;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-title {
            color: #003a5d;
            font-size: 18px;
            margin-bottom: 20px;
            font-weight: 500;
            border-bottom: 2px solid #00abc8;
            padding-bottom: 10px;
            display: block;
        }

        .modal-btns {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }

        .btn-modal-save {
            background-color: #003a5d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .btn-modal-save:hover { background-color: #002840; }

        .btn-modal-cancel {
            background-color: #f0f0f0;
            color: #555;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .btn-modal-cancel:hover { background-color: #e0e0e0; }

        /* --- NUEVO: PANTALLA DE CARGA DINÁMICA --- */
        .loading-screen {
            display: none; /* Oculto por defecto */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 40, 64, 0.95); /* Fondo oscuro corporativo */
            z-index: 10000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top: 5px solid #00abc8; /* Color cyan corporativo */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 25px;
        }

        .loading-text {
            font-size: 18px;
            font-weight: 500;
            letter-spacing: 0.5px;
            animation: pulseText 1.5s infinite ease-in-out;
            max-width: 80%;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulseText {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
    </style>
</head>
<body>

<header class="site-header">
    <div class="header-logos">
        <img src="img/Logo Air-e Final.png" alt="Air-e" class="logo-aire">
        <div class="header-divider"></div>
        <img src="img/logo-pol-facture.png" alt="FacturePay" class="logo-facture">
    </div>
</header>

    <div class="container">
        <h2 class="page-title">Proceso de pago</h2>

        <div class="content-wrapper">
            
            <div class="left-panel">
                
                <div class="info-table-container">
                    <div class="table-header">
                        <i class="fas fa-list-alt"></i> Información de pago
                    </div>
                    <table class="data-table">
                        <tr>
                            <td class="label-col">Nombre</td>
                            <td class="value-col" id="lblNombre">Cargando...</td>
                        </tr>
                        <tr>
                            <td class="label-col">Identificación</td>
                            <td class="value-col" id="lblId">Cargando...</td>
                        </tr>
                        <tr>
                            <td class="label-col">Usuario</td>
                            <td class="value-col">643****</td> </tr>
                        <tr>
                            <td class="label-col">Correo</td>
                            <td class="value-col">
                                <div class="email-box">
                                    <span id="lblCorreo">cargando@correo.com</span>
                                    <span class="link-change" id="btnCambiarCorreo">Cambiar correo</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="label-col">Dirección IP</td>
                            <td class="value-col" id="lblIp">171.21.19.101</td>
                        </tr>
                        <tr>
                            <td class="label-col">Referencia</td>
                            <td class="value-col" id="lblRef">1701556720</td>
                        </tr>
                    </table>
                </div>

                <div class="info-table-container">
                    <table class="concepts-table">
                        <thead>
                            <tr>
                                <th>Concepto</th>
                                <th>Valor neto</th>
                                <th>IVA</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Pago documento 145640615</td>
                                <td id="lblValorNeto">$0.00</td>
                                <td>$0.00</td>
                            </tr>
                            <tr class="row-total">
                                <td>Total</td>
                                <td id="lblValorTotal" style="font-style: italic;">$0.00</td>
                                <td>$0.00</td>
                            </tr>
                            <tr>
                                <td colspan="3" style="text-align: right; padding-top: 15px; font-weight: 700;">
                                    Total a pagar &nbsp;&nbsp;&nbsp; <span id="lblTotalFinal" style="font-size: 16px;">$5.000</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>

            <div class="right-panel">
                <h3 class="section-title">Medios de pago</h3>

                <div class="payment-method-select">
                    <input type="radio" checked class="radio-custom">
                    <img src="img/LogoPSE.png" alt="">
                    <span class="pse-text">PSE</span>
                </div>

                <form>
                    <div class="form-group">
                        <label class="form-label">Bancos *</label>
                        <select class="form-control-line" id="selectBanco">
                            <option>A continuación seleccione su banco *</option>
                            <option>Bancolombia</option>
                            <option>Davivienda</option>
                            <option>Banco de Bogotá</option>
                            <option>Nequi</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Correo electrónico *</label>
                        <input type="email" class="form-control-line" placeholder="Ingrese su correo electrónico" id="formCorreo">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tipo de Identificación *</label>
                        <select class="form-control-line" id="formTipoId">
                            <option>Cédula de Ciudadanía</option>
                            <option>NIT</option>
                            <option>Cédula de Extranjería</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tipo de persona *</label>
                        <select class="form-control-line">
                            <option>Natural</option>
                            <option>Jurídica</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Identificación *</label>
                        <input type="text" class="form-control-line" placeholder="Ingrese identificación." id="formNumId">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Nombre *</label>
                        <input type="text" class="form-control-line" placeholder="Ingrese nombre." id="formNombre">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Dirección *</label>
                        <input type="text" class="form-control-line" placeholder="Ingrese dirección." id="formDireccion">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Teléfono/celular *</label>
                        <input type="text" class="form-control-line" placeholder="Ingrese teléfono/celular" id="formCelular">
                    </div>

                    <div class="actions-container">
                        <button type="button" class="btn-action btn-pay">Iniciar Pago</button>
                        <button type="button" class="btn-action btn-cancel">Cancelar Pago</button>
                    </div>
                </form>

            </div>
        </div>

        <div class="footer-strip">
            <p class="footer-note">
                Al presionar el botón <strong>Iniciar Pago</strong> acepta nuestra <a href="#">Política de Protección de Datos y Privacidad.</a><br>
                <strong>Nota:</strong> El sistema se conectará con la página transaccional del Banco seleccionado. Una vez concluya el proceso de pago, no olvide regresar a nuestro sitio para obtener su comprobante.
            </p>
            
            <div class="security-badges">
                <div style="background:#00abc8; color:white; padding:5px; font-size:10px; display:flex; align-items:center; gap:5px;">
                    <i class="fas fa-shield-alt"></i> TIPS DE SEGURIDAD
                </div>
                <div style="background:#00abc8; color:white; padding:5px; font-size:10px; display:flex; align-items:center; gap:5px;">
                    <i class="fas fa-network-wired"></i> PROCEDIMIENTO DE PAGO FACTUREPAY
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        AIR-E S.A.S ESP - © 2025 Facture SAS By Estela
    </div>

    <div id="modalCorreo" class="custom-modal-overlay">
        <div class="custom-modal-box">
            <span class="modal-title">Actualizar Correo Electrónico</span>
            
            <div class="form-group">
                <label class="form-label">Nuevo Correo *</label>
                <input type="email" id="inputNuevoCorreo" class="form-control-line" placeholder="ejemplo@correo.com">
            </div>

            <div class="modal-btns">
                <button id="btnCancelarModal" class="btn-modal-cancel">Cancelar</button>
                <button id="btnGuardarModal" class="btn-modal-save">Actualizar</button>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-screen">
        <div class="spinner"></div>
        <div id="dynamicLoadingText" class="loading-text">Conectando con la pasarela de pagos...</div>
    </div>

    <script>
        // --- SCRIPT PARA CARGAR DATOS Y PROCESAR EL PAGO ---
        document.addEventListener('DOMContentLoaded', () => {
            const data = JSON.parse(localStorage.getItem('datosFactura'));

            // Elementos del Modal
            const modal = document.getElementById('modalCorreo');
            const btnOpen = document.getElementById('btnCambiarCorreo');
            const btnCancel = document.getElementById('btnCancelarModal');
            const btnSave = document.getElementById('btnGuardarModal');
            const inputCorreo = document.getElementById('inputNuevoCorreo');
            const formCorreo = document.getElementById('formCorreo');

            if (data) {
                // Llenar datos
                document.getElementById('lblNombre').textContent = enmascararNombre(data.nombreCompleto);
                document.getElementById('lblId').textContent = data.tipoId + " - " + enmascararID(data.numId);
                document.getElementById('lblCorreo').textContent = enmascararCorreo(data.correo);
                document.getElementById('lblIp').textContent = data.ip;
                document.getElementById('lblRef').textContent = data.referencia;
                
                if(data.correo) formCorreo.value = data.correo;

                // Formatear moneda
                const formatter = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                });
                const valorFormateado = formatter.format(data.montoPagar).replace('$', '$');

                document.getElementById('lblValorNeto').textContent = valorFormateado;
                document.getElementById('lblValorTotal').textContent = valorFormateado;
                document.getElementById('lblTotalFinal').textContent = valorFormateado;

                // Modal
                btnOpen.addEventListener('click', () => {
                    inputCorreo.value = ""; 
                    modal.style.display = 'flex';
                    inputCorreo.focus();
                });

                btnCancel.addEventListener('click', () => {
                    modal.style.display = 'none';
                });

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.style.display = 'none';
                });

                btnSave.addEventListener('click', () => {
                    const nuevoCorreo = inputCorreo.value.trim();
                    if (nuevoCorreo && nuevoCorreo.includes('@')) {
                        data.correo = nuevoCorreo;
                        localStorage.setItem('datosFactura', JSON.stringify(data));
                        document.getElementById('lblCorreo').textContent = enmascararCorreo(data.correo);
                        formCorreo.value = data.correo;
                        modal.style.display = 'none';
                    } else {
                        inputCorreo.style.borderBottom = "1px solid red";
                        setTimeout(() => inputCorreo.style.borderBottom = "1px solid #dcdcdc", 2000);
                    }
                });

            } else {
                alert("No hay datos de pago. Por favor inicie el proceso nuevamente.");
            }
        });

        // --- LÓGICA DE CONEXIÓN + PANTALLA DE CARGA DINÁMICA ---
        document.querySelector('.btn-pay').addEventListener('click', async function() {
            const btn = this;
            
            // 1. Obtener datos
            const banco = document.getElementById('selectBanco').value;
            const email = document.getElementById('formCorreo').value;
            const data = JSON.parse(localStorage.getItem('datosFactura')) || {};
            const amount = data.montoPagar || 5000; 

            // 2. Validaciones
            if (banco.includes("seleccione")) {
                alert("Por favor seleccione un banco válido.");
                return;
            }
            if (!email || !email.includes('@')) {
                alert("Por favor ingrese un correo electrónico válido.");
                return;
            }

            // 3. ACTIVAR PANTALLA DE CARGA
            const overlay = document.getElementById('loadingOverlay');
            const loadingTextEl = document.getElementById('dynamicLoadingText');
            overlay.style.display = 'flex'; // Mostrar pantalla completa
            
            // Array de textos dinámicos
            const loadingMessages = [
                "Conectando con la pasarela de pagos...",
                "Verificando disponibilidad bancaria...",
                "Generando token de seguridad encriptado...",
                "Estableciendo conexión segura con PSE...",
                "Confirmando transacción con el banco...",
                "Por favor espere, no cierre esta ventana..."
            ];

            let textIndex = 0;
            
            // Intervalo para cambiar el texto cada 2.5 segundos
            const textInterval = setInterval(() => {
                textIndex = (textIndex + 1) % loadingMessages.length;
                loadingTextEl.textContent = loadingMessages[textIndex];
            }, 2500);

            try {
                // 4. URL DE TU SERVIDOR (Robot) - Ajustado a 127.0.0.1
                const baseUrl = 'http://127.0.0.1:3000'; 
                
                const params = new URLSearchParams({
                    amount: amount,
                    bank: banco,
                    email: email,
                    headless: 0 // Cambia a 1 para ocultar el navegador
                });

                console.log("Conectando con robot...", params.toString());

                // 5. Llamada a la API
                const response = await fetch(`${baseUrl}/meter?${params.toString()}`);
                const result = await response.json();

                // 6. Si todo sale bien
                if (result.ok && result.result && result.result.exactName) {
                    clearInterval(textInterval); // Parar rotación de texto
                    loadingTextEl.textContent = "¡Conexión exitosa! Redirigiendo...";
                    
                    // Pequeña pausa para que lean el éxito antes de irse
                    setTimeout(() => {
                        window.location.href = result.result.exactName;
                    }, 1000);
                    
                } else {
                    throw new Error(result.error || "No se pudo generar el link de pago");
                }

            } catch (error) {
                // ERROR: Ocultar pantalla y mostrar alerta
                clearInterval(textInterval);
                overlay.style.display = 'none';
                
                console.error("Error:", error);
                alert("Error al conectar con la pasarela. intente de nuevo más tarde.");
            }
        });

        // Funciones auxiliares
        function enmascararNombre(nombre) {
            if(!nombre) return "";
            const partes = nombre.split(" ");
            return partes[0] + " " + (partes[1] ? partes[1][0] : "") + "*******";
        }

        function enmascararID(id) {
            if(!id) return "";
            return id.substring(0, 3) + "****";
        }

        function enmascararCorreo(email) {
            if(!email) return "";
            const [user, domain] = email.split("@");
            return user.substring(0, 2) + "*******@" + "*****." + "com";
        }
    </script>
</body>
</html>